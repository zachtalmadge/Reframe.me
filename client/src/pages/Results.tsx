import { useEffect, useState } from "react";
import { useSearch, Link, useLocation } from "wouter";
import { FileText, Mail, Download, Home, AlertTriangle, Copy, Check } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import Layout from "@/components/Layout";
import { ToolType } from "@/lib/formState";
import { loadResults, NarrativeItem, ResponseLetter, clearResults } from "@/lib/resultsPersistence";
import { useToast } from "@/hooks/use-toast";

const narrativeTypeLabels: Record<string, string> = {
  full_disclosure: "Direct & Professional",
  skills_focused: "Skills-First Approach",
  growth_journey: "Growth-Focused",
  minimal_disclosure: "Brief & Confident",
  values_aligned: "Values-Aligned",
};

const narrativeTypeDescriptions: Record<string, string> = {
  full_disclosure: "Honest, straightforward acknowledgment with emphasis on accountability",
  skills_focused: "Leads with qualifications and abilities, briefly acknowledges background",
  growth_journey: "Emphasizes personal transformation and rehabilitation journey",
  minimal_disclosure: "Concise acknowledgment without over-explaining, projects confidence",
  values_aligned: "Connects personal values and growth to the organization's mission",
};

export default function Results() {
  const [, navigate] = useLocation();
  const searchString = useSearch();
  const params = new URLSearchParams(searchString);
  const tool = (params.get("tool") as ToolType) || "narrative";
  const { toast } = useToast();

  const [narratives, setNarratives] = useState<NarrativeItem[]>([]);
  const [responseLetter, setResponseLetter] = useState<ResponseLetter | null>(null);
  const [copiedId, setCopiedId] = useState<string | null>(null);

  useEffect(() => {
    const persisted = loadResults();
    if (!persisted) {
      navigate("/");
      return;
    }

    setNarratives(persisted.result.narratives);
    setResponseLetter(persisted.result.responseLetter);
  }, [navigate]);

  const showNarratives = tool === "narrative" || tool === "both";
  const showResponseLetter = tool === "responseLetter" || tool === "both";

  const handleCopy = async (text: string, id: string) => {
    try {
      await navigator.clipboard.writeText(text);
      setCopiedId(id);
      toast({
        title: "Copied to clipboard",
        description: "The content has been copied to your clipboard.",
      });
      setTimeout(() => setCopiedId(null), 2000);
    } catch (err) {
      toast({
        title: "Failed to copy",
        description: "Please try selecting and copying the text manually.",
        variant: "destructive",
      });
    }
  };

  const handleDownloadNarratives = () => {
    if (narratives.length === 0) return;

    let content = "DISCLOSURE NARRATIVES\n";
    content += "Generated by ReflectMe\n";
    content += "=".repeat(50) + "\n\n";

    narratives.forEach((narrative, index) => {
      content += `${index + 1}. ${narrative.title || narrativeTypeLabels[narrative.type] || narrative.type}\n`;
      content += "-".repeat(40) + "\n\n";
      content += narrative.content + "\n\n";
      content += "=".repeat(50) + "\n\n";
    });

    const blob = new Blob([content], { type: "text/plain" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "disclosure-narratives.txt";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  const handleDownloadLetter = () => {
    if (!responseLetter) return;

    let content = "PRE-ADVERSE ACTION RESPONSE LETTER\n";
    content += "Generated by ReflectMe\n";
    content += "=".repeat(50) + "\n\n";
    content += responseLetter.content;

    const blob = new Blob([content], { type: "text/plain" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "response-letter.txt";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  const handleStartOver = () => {
    clearResults();
    navigate("/");
  };

  return (
    <Layout>
      <section
        className="py-8 md:py-12 px-4 sm:px-6 lg:px-8"
        aria-labelledby="results-heading"
      >
        <div className="max-w-3xl mx-auto space-y-8">
          <Card className="border-amber-200 dark:border-amber-800 bg-amber-50/50 dark:bg-amber-950/20">
            <CardContent className="pt-6">
              <div className="flex gap-4">
                <AlertTriangle
                  className="w-6 h-6 text-amber-600 dark:text-amber-400 flex-shrink-0 mt-0.5"
                  aria-hidden="true"
                />
                <div className="space-y-2">
                  <h2 className="font-semibold text-foreground">
                    Important Disclaimer
                  </h2>
                  <p className="text-sm text-muted-foreground leading-relaxed">
                    These documents are personalized tools to help you prepare
                    for employment conversations. They are not legal advice.
                    Please review and customize them to reflect your personal
                    situation before using them with potential employers.
                  </p>
                </div>
              </div>
            </CardContent>
          </Card>

          <div className="text-center space-y-4">
            <h1
              id="results-heading"
              className="text-2xl md:text-3xl font-bold text-foreground"
            >
              Your Documents Are Ready
            </h1>
            <p className="text-muted-foreground">
              Review and download your personalized documents below.
            </p>
          </div>

          <div className="space-y-6">
            {showNarratives && narratives.length > 0 && (
              <Card data-testid="card-narratives">
                <CardHeader className="flex flex-row items-center gap-4">
                  <div className="w-12 h-12 rounded-lg bg-primary/10 flex items-center justify-center flex-shrink-0">
                    <FileText
                      className="w-6 h-6 text-primary"
                      aria-hidden="true"
                    />
                  </div>
                  <div className="flex-1 min-w-0">
                    <CardTitle className="text-lg">
                      Disclosure Narratives
                    </CardTitle>
                    <p className="text-sm text-muted-foreground mt-1">
                      {narratives.length} different ways to discuss your background
                    </p>
                  </div>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="space-y-4">
                    {narratives.map((narrative, index) => (
                      <div
                        key={narrative.id}
                        className="p-4 rounded-lg bg-muted/50 space-y-3"
                        data-testid={`narrative-style-${index + 1}`}
                      >
                        <div className="flex items-start justify-between gap-2">
                          <div>
                            <h3 className="font-medium text-foreground">
                              {narrative.title || narrativeTypeLabels[narrative.type] || `Narrative ${index + 1}`}
                            </h3>
                            <p className="text-xs text-muted-foreground mt-0.5">
                              {narrativeTypeDescriptions[narrative.type] || ""}
                            </p>
                          </div>
                          <Button
                            size="icon"
                            variant="ghost"
                            onClick={() => handleCopy(narrative.content, narrative.id)}
                            data-testid={`button-copy-narrative-${index + 1}`}
                          >
                            {copiedId === narrative.id ? (
                              <Check className="w-4 h-4 text-green-600" />
                            ) : (
                              <Copy className="w-4 h-4" />
                            )}
                          </Button>
                        </div>
                        <div className="text-sm text-foreground leading-relaxed whitespace-pre-wrap">
                          {narrative.content}
                        </div>
                      </div>
                    ))}
                  </div>
                  <Button 
                    className="w-full" 
                    onClick={handleDownloadNarratives}
                    data-testid="button-download-narratives"
                  >
                    <Download className="w-4 h-4 mr-2" aria-hidden="true" />
                    Download All Narratives
                  </Button>
                </CardContent>
              </Card>
            )}

            {showResponseLetter && responseLetter && (
              <Card data-testid="card-response-letter">
                <CardHeader className="flex flex-row items-center gap-4">
                  <div className="w-12 h-12 rounded-lg bg-secondary/10 flex items-center justify-center flex-shrink-0">
                    <Mail
                      className="w-6 h-6 text-secondary"
                      aria-hidden="true"
                    />
                  </div>
                  <div className="flex-1 min-w-0">
                    <CardTitle className="text-lg">
                      Pre-Adverse Action Response Letter
                    </CardTitle>
                    <p className="text-sm text-muted-foreground mt-1">
                      A formal response for background check concerns
                    </p>
                  </div>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="p-4 rounded-lg bg-muted/50 space-y-3">
                    <div className="flex items-start justify-between gap-2">
                      <h3 className="font-medium text-foreground">
                        {responseLetter.title}
                      </h3>
                      <Button
                        size="icon"
                        variant="ghost"
                        onClick={() => handleCopy(responseLetter.content, responseLetter.id)}
                        data-testid="button-copy-letter"
                      >
                        {copiedId === responseLetter.id ? (
                          <Check className="w-4 h-4 text-green-600" />
                        ) : (
                          <Copy className="w-4 h-4" />
                        )}
                      </Button>
                    </div>
                    <div className="text-sm text-foreground leading-relaxed whitespace-pre-wrap">
                      {responseLetter.content}
                    </div>
                  </div>
                  <Button
                    className="w-full"
                    variant="secondary"
                    onClick={handleDownloadLetter}
                    data-testid="button-download-letter"
                  >
                    <Download className="w-4 h-4 mr-2" aria-hidden="true" />
                    Download Response Letter
                  </Button>
                </CardContent>
              </Card>
            )}

            {showNarratives && narratives.length === 0 && (
              <Card>
                <CardContent className="py-8 text-center">
                  <p className="text-muted-foreground">
                    No narratives were generated. Please try again.
                  </p>
                </CardContent>
              </Card>
            )}

            {showResponseLetter && !responseLetter && (
              <Card>
                <CardContent className="py-8 text-center">
                  <p className="text-muted-foreground">
                    No response letter was generated. Please try again.
                  </p>
                </CardContent>
              </Card>
            )}
          </div>

          <div className="pt-4 border-t border-border">
            <div className="flex flex-col sm:flex-row items-center justify-between gap-4">
              <p className="text-sm text-muted-foreground text-center sm:text-left">
                Need to make changes? You can start over anytime.
              </p>
              <Button 
                variant="outline" 
                onClick={handleStartOver}
                data-testid="button-start-over"
              >
                <Home className="w-4 h-4 mr-2" aria-hidden="true" />
                Start Over
              </Button>
            </div>
          </div>
        </div>
      </section>
    </Layout>
  );
}
